<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlex - Minhas Tarefas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>TaskFlex</h1>
            <span id="logged-in-user" class="logged-in-user"></span>
            <nav>
                <ul>
                    <!-- Os links de navegação podem ser simplificados ou mantidos -->
                    <li><a href="#" id="nav-my-tasks" class="active">Minhas Tarefas</a></li>
                    <li><a href="#" id="nav-about">Sobre o TaskFlex</a></li>
                    <li><a href="index.html" id="logout-btn" class="btn btn-sm">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="my-tasks" class="tasks-section">
            <div class="container">
                <h2>Minhas Tarefas</h2>
                <div class="task-controls">
                    <button id="btn-new-task" class="btn">Nova Tarefa</button>
                    <!-- Filtros podem ser implementados no futuro -->
                </div>
                <!-- A lista de tarefas será preenchida dinamicamente pelo JavaScript -->
                <ul id="task-list" class="task-list"></ul>
            </div>
        </section>

        <section id="new-task-form-section" class="new-task-section hidden">
            <div class="container">
                <h2 id="form-title">Nova Tarefa</h2>
                <form id="task-form">
                    <!-- Campo escondido para guardar o ID da tarefa durante a edição -->
                    <input type="hidden" id="task-id">
                    <div class="form-group">
                        <label for="task-title">Título:</label>
                        <input type="text" id="task-title" name="task-title" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Descrição:</label>
                        <textarea id="task-description" name="task-description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">Data de Entrega:</label>
                        <input type="date" id="delivery-date" name="delivery-date">
                    </div>
                    <div class="form-group">
                        <label for="priority">Prioridade:</label>
                        <select id="priority" name="priority">
                            <option value="high">Alta</option>
                            <option value="medium" selected>Média</option>
                            <option value="low">Baixa</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn primary">Salvar</button>
                        <button type="button" class="btn secondary" id="btn-cancel-task">Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="about-taskflex" class="about-section hidden">
            <div class="container">
                <h2>Sobre o TaskFlex</h2>
                <p>Esta é a sua aplicação de gestão de tarefas, agora totalmente funcional com um back-end em Python e uma base de dados persistente!</p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 TaskFlex. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        // URL base da sua API no Render
        const API_URL = 'https://taskflex.onrender.com';

        // Elementos da página
        const taskList = document.getElementById('task-list');
        const loggedInUserElement = document.getElementById('logged-in-user');
        const taskFormSection = document.getElementById('new-task-form-section');
        const myTasksSection = document.getElementById('my-tasks');
        const aboutSection = document.getElementById('about-taskflex');
        const taskForm = document.getElementById('task-form');
        
        // --- Lógica de Autenticação e Carregamento Inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');

            if (!userId || !username) {
                // Se não houver dados do utilizador, volta para a página de login
                alert('Sessão inválida. Por favor, faça login novamente.');
                window.location.href = 'index.html';
                return;
            }

            // Exibe o nome do utilizador
            loggedInUserElement.textContent = `Olá, ${username}!`;
            loggedInUserElement.style.display = 'block';

            // Carrega as tarefas do utilizador
            loadTasks(userId);
        });

        // --- Funções de Navegação ---
        document.getElementById('nav-my-tasks').addEventListener('click', (e) => {
            e.preventDefault();
            myTasksSection.classList.remove('hidden');
            aboutSection.classList.add('hidden');
            taskFormSection.classList.add('hidden');
        });

        document.getElementById('nav-about').addEventListener('click', (e) => {
            e.preventDefault();
            myTasksSection.classList.add('hidden');
            aboutSection.classList.remove('hidden');
            taskFormSection.classList.add('hidden');
        });

        document.getElementById('btn-new-task').addEventListener('click', () => {
            taskForm.reset();
            document.getElementById('task-id').value = '';
            document.getElementById('form-title').textContent = 'Nova Tarefa';
            taskFormSection.classList.remove('hidden');
            myTasksSection.classList.add('hidden');
        });

        document.getElementById('btn-cancel-task').addEventListener('click', () => {
            taskFormSection.classList.add('hidden');
            myTasksSection.classList.remove('hidden');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            // Não é necessário preventDefault, pois o link já aponta para index.html
        });

        // --- Funções de Comunicação com a API ---

        // Carregar tarefas do utilizador
        async function loadTasks(userId) {
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}/tasks`);
                const tasks = await response.json();
                
                taskList.innerHTML = ''; // Limpa a lista antes de adicionar as novas tarefas
                tasks.forEach(task => renderTask(task));
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                alert('Não foi possível carregar as tarefas.');
            }
        }

        // Renderizar uma única tarefa na lista
        function renderTask(task) {
            const item = document.createElement('li');
            item.classList.add('task-item');
            if (task.completed) {
                item.classList.add('completed');
            }
            item.dataset.id = task.id;

            const formattedDate = task.dueDate ? new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem prazo';

            item.innerHTML = `
                <input type="checkbox" ${task.completed ? 'checked' : ''}>
                <label>${task.title} – Prazo: ${formattedDate}</label>
                <div class="task-actions">
                    <button class="edit-task-btn">Editar</button>
                    <button class="delete-task-btn">Excluir</button>
                </div>
            `;
            
            // Adicionar eventos aos novos elementos
            item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleTaskCompletion(task.id, e.target.checked));
            item.querySelector('.edit-task-btn').addEventListener('click', () => handleEdit(task));
            item.querySelector('.delete-task-btn').addEventListener('click', () => deleteTask(task.id));

            taskList.appendChild(item);
        }

        // Lidar com o envio do formulário (Criar ou Editar)
        taskForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            const taskId = document.getElementById('task-id').value;

            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                dueDate: document.getElementById('delivery-date').value,
                priority: document.getElementById('priority').value,
                userId: parseInt(userId)
            };

            let url = `${API_URL}/api/tasks`;
            let method = 'POST';

            if (taskId) {
                // Se há um ID, é uma edição (PUT)
                url = `${API_URL}/api/tasks/${taskId}`;
                method = 'PUT';
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                if (!response.ok) throw new Error('Falha ao salvar a tarefa.');
                
                loadTasks(userId); // Recarrega a lista de tarefas
                taskFormSection.classList.add('hidden');
                myTasksSection.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Não foi possível salvar a tarefa.');
            }
        });

        // Apagar uma tarefa
        async function deleteTask(taskId) {
            if (!confirm('Tem a certeza que deseja excluir esta tarefa?')) return;

            try {
                await fetch(`${API_URL}/api/tasks/${taskId}`, { method: 'DELETE' });
                document.querySelector(`[data-id='${taskId}']`).remove();
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                alert('Não foi possível excluir a tarefa.');
            }
        }
        
        // Preencher o formulário para edição
        function handleEdit(task) {
            taskFormSection.classList.remove('hidden');
            myTasksSection.classList.add('hidden');
            
            document.getElementById('form-title').textContent = 'Editar Tarefa';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description;
            document.getElementById('delivery-date').value = task.dueDate;
            document.getElementById('priority').value = task.priority;
        }

        // Marcar tarefa como concluída/pendente
        async function toggleTaskCompletion(taskId, isCompleted) {
             try {
                await fetch(`${API_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: isCompleted })
                });
                loadTasks(localStorage.getItem('userId')); // Recarrega para mostrar o estilo
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Não foi possível atualizar o estado da tarefa.');
            }
        }
    </script>
</body>
</html>

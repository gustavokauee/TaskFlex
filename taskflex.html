<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlex - Minhas Tarefas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>TaskFlex</h1>
            <span id="logged-in-user" class="logged-in-user"></span>
            <nav>
                <ul>
                    <li><a href="#" id="nav-my-tasks" class="active">Minhas Tarefas</a></li>
                    <li><a href="#" id="nav-about">Sobre o TaskFlex</a></li>
                    <li><a href="index.html" id="logout-btn" class="btn btn-sm">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="my-tasks" class="tasks-section">
            <div class="container">
                <h2>Minhas Tarefas</h2>
                <div class="task-controls">
                    <button id="btn-new-task" class="btn">Nova Tarefa</button>
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="pending">Pendentes</button>
                        <button class="filter-btn" data-filter="completed">Concluídas</button>
                    </div>
                </div>
                <ul id="task-list" class="task-list"></ul>
            </div>
        </section>

        <section id="new-task-form-section" class="new-task-section hidden">
            <div class="container">
                <h2 id="form-title">Nova Tarefa</h2>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="form-group">
                        <label for="task-title">Título:</label>
                        <input type="text" id="task-title" name="task-title" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Descrição:</label>
                        <textarea id="task-description" name="task-description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">Data de Entrega:</label>
                        <input type="date" id="delivery-date" name="delivery-date">
                    </div>
                    <div class="form-group">
                        <label for="priority">Prioridade:</label>
                        <select id="priority" name="priority">
                            <option value="high">Alta</option>
                            <option value="medium" selected>Média</option>
                            <option value="low">Baixa</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn primary">Salvar</button>
                        <button type="button" class="btn secondary" id="btn-cancel-task">Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="about-taskflex" class="about-section hidden">
            <div class="container">
                <h2>Sobre o TaskFlex</h2>
                <p>Esta é a sua aplicação de gestão de tarefas, agora totalmente funcional com um back-end em Python e uma base de dados persistente!</p>
            </div>
        </section>

        <section id="calendar-section" class="calendar-section hidden">
            <div class="container">
                <h2>Calendário</h2>
                <div class="calendar-header">
                    <button id="prev-month-btn" class="btn secondary">&lt;</button>
                    <h3 id="current-month-year"></h3>
                    <button id="next-month-btn" class="btn secondary">&gt;</button>
                </div>
                <div class="calendar-grid-container">
                    <div class="calendar-weekdays">
                        <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                    </div>
                    <div id="calendar-days" class="calendar-days"></div>
                </div>
                <button id="btn-close-calendar" class="btn secondary full-width">Fechar Calendário</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <button class="btn footer-btn" id="btn-show-calendar">Ver calendário</button>
            <p>&copy; 2025 TaskFlex. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        const API_URL = 'https://taskflex.onrender.com';

        // Elementos da página
        const taskListEl = document.getElementById('task-list');
        const loggedInUserEl = document.getElementById('logged-in-user');
        const taskFormSectionEl = document.getElementById('new-task-form-section');
        const myTasksSectionEl = document.getElementById('my-tasks');
        const aboutSectionEl = document.getElementById('about-taskflex');
        const taskFormEl = document.getElementById('task-form');
        const calendarSectionEl = document.getElementById('calendar-section');

        let allTasks = []; // Armazena todas as tarefas para filtrar localmente

        // --- Lógica de Autenticação e Carregamento Inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');

            if (!userId || !username) {
                alert('Sessão inválida. Por favor, faça login novamente.');
                window.location.href = 'index.html';
                return;
            }

            loggedInUserEl.textContent = `Olá, ${username}!`;
            loggedInUserEl.style.display = 'block';
            loadTasks(userId);
        });

        // --- Funções de Navegação ---
        function showSection(sectionToShow) {
            [myTasksSectionEl, aboutSectionEl, taskFormSectionEl, calendarSectionEl].forEach(section => {
                section.classList.add('hidden');
            });
            sectionToShow.classList.remove('hidden');
        }

        document.getElementById('nav-my-tasks').addEventListener('click', (e) => { e.preventDefault(); showSection(myTasksSectionEl); });
        document.getElementById('nav-about').addEventListener('click', (e) => { e.preventDefault(); showSection(aboutSectionEl); });
        document.getElementById('btn-new-task').addEventListener('click', () => {
            taskFormEl.reset();
            document.getElementById('task-id').value = '';
            document.getElementById('form-title').textContent = 'Nova Tarefa';
            showSection(taskFormSectionEl);
        });
        document.getElementById('btn-cancel-task').addEventListener('click', () => showSection(myTasksSectionEl));
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
        });

        // --- Lógica de Tarefas (API) ---

        async function loadTasks(userId) {
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}/tasks`);
                allTasks = await response.json();
                renderTaskList(allTasks); // Renderiza todas as tarefas inicialmente
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                alert('Não foi possível carregar as tarefas.');
            }
        }

        function renderTaskList(tasksToRender) {
            taskListEl.innerHTML = '';
            tasksToRender.forEach(task => {
                const item = document.createElement('li');
                item.className = `task-item ${task.completed ? 'completed' : 'pending'}`;
                item.dataset.id = task.id;

                const formattedDate = task.dueDate ? new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem prazo';

                item.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}>
                    <label>${task.title} – Prazo: ${formattedDate}</label>
                    <div class="task-actions">
                        <button class="edit-task-btn">Editar</button>
                        <button class="delete-task-btn">Excluir</button>
                    </div>
                `;
                
                item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleTaskCompletion(task.id, e.target.checked));
                item.querySelector('.edit-task-btn').addEventListener('click', () => handleEdit(task));
                item.querySelector('.delete-task-btn').addEventListener('click', () => deleteTask(task.id));

                taskListEl.appendChild(item);
            });
        }

        taskFormEl.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            const taskId = document.getElementById('task-id').value;

            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                dueDate: document.getElementById('delivery-date').value,
                priority: document.getElementById('priority').value,
                userId: parseInt(userId)
            };

            const url = taskId ? `${API_URL}/api/tasks/${taskId}` : `${API_URL}/api/tasks`;
            const method = taskId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                if (!response.ok) throw new Error('Falha ao salvar a tarefa.');
                
                await loadTasks(userId);
                showSection(myTasksSectionEl);
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Não foi possível salvar a tarefa.');
            }
        });

        async function deleteTask(taskId) {
            if (!confirm('Tem a certeza que deseja excluir esta tarefa?')) return;
            try {
                await fetch(`${API_URL}/api/tasks/${taskId}`, { method: 'DELETE' });
                allTasks = allTasks.filter(t => t.id !== taskId);
                renderTaskList(allTasks);
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                alert('Não foi possível excluir a tarefa.');
            }
        }
        
        function handleEdit(task) {
            showSection(taskFormSectionEl);
            document.getElementById('form-title').textContent = 'Editar Tarefa';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description;
            document.getElementById('delivery-date').value = task.dueDate;
            document.getElementById('priority').value = task.priority;
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
             try {
                const response = await fetch(`${API_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: isCompleted })
                });
                const updatedTask = await response.json();
                const taskIndex = allTasks.findIndex(t => t.id === taskId);
                allTasks[taskIndex] = updatedTask;
                renderTaskList(allTasks);
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Não foi possível atualizar o estado da tarefa.');
            }
        }

        // --- Lógica dos Filtros ---
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const filter = this.dataset.filter;
                let filteredTasks = allTasks;
                if (filter === 'pending') {
                    filteredTasks = allTasks.filter(task => !task.completed);
                } else if (filter === 'completed') {
                    filteredTasks = allTasks.filter(task => task.completed);
                }
                renderTaskList(filteredTasks);
            });
        });

        // --- Lógica do Calendário ---
        const currentMonthYearEl = document.getElementById('current-month-year');
        const calendarDaysEl = document.getElementById('calendar-days');
        let currentDate = new Date();

        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            currentMonthYearEl.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDay = firstDayOfMonth.getDay();

            for (let i = 0; i < startDay; i++) {
                calendarDaysEl.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.textContent = day;
                const today = new Date();
                if (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth() && day === today.getDate()) {
                    dayDiv.classList.add('today');
                }
                calendarDaysEl.appendChild(dayDiv);
            }
        }

        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById('btn-show-calendar').addEventListener('click', () => {
            showSection(calendarSectionEl);
            renderCalendar();
        });
        
        document.getElementById('btn-close-calendar').addEventListener('click', () => showSection(myTasksSectionEl));

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlex - Minhas Tarefas</title>
    <link rel="stylesheet" href="style.css">
    <!-- Estilos para as novas funcionalidades -->
    <style>
        .quote-container {
            text-align: center;
            margin: -15px auto 25px auto;
            padding: 10px;
            background-color: #f0f9ff;
            border-radius: 8px;
            font-style: italic;
            color: #0c4a6e;
            border: 1px solid #bae6fd;
            max-width: 80%;
        }
        .task-item.overdue {
            border-left: 5px solid #ef4444;
            background-color: #fef2f2;
        }
        .overdue-warning {
            color: #b91c1c;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 20px;
        }
        .focus-btn {
            background: none; border: none; cursor: pointer; font-size: 1.3em;
            margin-right: 10px; transition: transform 0.2s;
        }
        .focus-btn:hover { transform: scale(1.3); }
        .focus-btn.is-focus { color: orange; }

        #focus-task-container {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #fffbeb, #fefce8);
            border: 2px dashed #facc15;
            border-radius: 10px;
        }
        #focus-task-container h3 {
            margin-top: 0;
            color: #ca8a04;
            text-align: center;
        }
        #focus-task-container .task-item { border-left-color: #facc15; }

        #dashboard-section { text-align: center; }
        .stats-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .stat-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 200px;
        }
        .stat-card h4 { margin-top: 0; color: #22127e; }
        .stat-card p { font-size: 2.5em; font-weight: bold; color: #4324d5; margin: 0; }
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        .progress-bar {
            width: 0%;
            height: 30px;
            background: linear-gradient(90deg, #4324d5, #2ecc71);
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>TaskFlex</h1>
            <span id="logged-in-user" class="logged-in-user"></span>
            <nav>
                <ul>
                    <li><a href="#" id="nav-my-tasks" class="active">Minhas Tarefas</a></li>
                    <!-- NOVO: Aba de Calendário adicionada -->
                    <li><a href="#" id="nav-calendar">Calendário</a></li>
                    <li><a href="#" id="nav-dashboard">Meu Desempenho</a></li>
                    <li><a href="#" id="nav-about">Sobre</a></li>
                    <li><a href="index.html" id="logout-btn" class="btn btn-sm">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="my-tasks" class="tasks-section">
            <div class="container">
                <h2>Minhas Tarefas</h2>
                <div id="quote-container" class="quote-container"></div>
                <div id="focus-task-container" class="hidden">
                    <h3>⭐ Foco do Dia</h3>
                    <ul id="focus-task-list" class="task-list"></ul>
                </div>
                <div class="task-controls">
                    <button id="btn-new-task" class="btn">Nova Tarefa</button>
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="pending">Pendentes</button>
                        <button class="filter-btn" data-filter="completed">Concluídas</button>
                    </div>
                </div>
                <ul id="task-list" class="task-list"></ul>
            </div>
        </section>

        <section id="new-task-form-section" class="new-task-section hidden"></section>

        <section id="about-taskflex" class="about-section hidden"></section>

        <section id="dashboard-section" class="hidden"></section>

        <!-- NOVO: Secção do Calendário adicionada de volta -->
        <section id="calendar-section" class="calendar-section hidden">
            <div class="container">
                <h2>Calendário</h2>
                <div class="calendar-header">
                    <button id="prev-month-btn" class="btn secondary">&lt;</button>
                    <h3 id="current-month-year"></h3>
                    <button id="next-month-btn" class="btn secondary">&gt;</button>
                </div>
                <div class="calendar-grid-container">
                    <div class="calendar-weekdays">
                        <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                    </div>
                    <div id="calendar-days" class="calendar-days"></div>
                </div>
            </div>
        </section>

    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 TaskFlex. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        const API_URL = 'https://taskflex.onrender.com';
        let allTasks = [];

        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');

            if (!userId || !username) {
                alert('Sessão inválida. Por favor, faça login novamente.');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('logged-in-user').textContent = `Olá, ${username}!`;
            document.getElementById('logged-in-user').style.display = 'inline-block';
            
            loadDynamicContent();
            loadTasks(userId);
            showMotivationalQuote();
        });

        async function loadTasks(userId) {
            try {
                const response = await fetch(`${API_URL}/api/users/${userId}/tasks`);
                allTasks = await response.json();
                renderUI();
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
            }
        }

        function renderUI() {
            const priorityMap = { 'high': 3, 'medium': 2, 'low': 1 };
            allTasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return (priorityMap[b.priority] || 0) - (priorityMap[a.priority] || 0);
            });
            
            const focusTaskId = localStorage.getItem('focusTaskId');
            const focusTask = focusTaskId ? allTasks.find(t => t.id == focusTaskId) : null;
            const regularTasks = focusTask ? allTasks.filter(t => t.id != focusTaskId) : allTasks;
            
            // Aplica o filtro ativo atualmente
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            applyFilter(activeFilter, regularTasks);
            
            const focusContainer = document.getElementById('focus-task-container');
            const focusList = document.getElementById('focus-task-list');
            if(focusTask) {
                renderTaskList([focusTask], focusList);
                focusContainer.classList.remove('hidden');
            } else {
                focusContainer.classList.add('hidden');
            }

            updateDashboard();
        }

        function renderTaskList(tasksToRender, targetElement) {
            targetElement.innerHTML = '';
            tasksToRender.forEach(task => {
                const item = document.createElement('li');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = task.dueDate ? new Date(task.dueDate + 'T00:00:00') : null;
                const isOverdue = dueDate && dueDate < today && !task.completed;

                item.className = `task-item ${task.completed ? 'completed' : 'pending'} ${isOverdue ? 'overdue' : ''}`;
                item.dataset.id = task.id;

                const formattedDate = dueDate ? dueDate.toLocaleDateString('pt-BR') : 'Sem prazo';
                const focusTaskId = localStorage.getItem('focusTaskId');

                item.innerHTML = `
                    <div>
                        <button class="focus-btn ${task.id == focusTaskId ? 'is-focus' : ''}" title="Focar nesta tarefa">⭐</button>
                        <input type="checkbox" ${task.completed ? 'checked' : ''}>
                        <label>${task.title} – Prazo: ${formattedDate}</label>
                        ${isOverdue ? '<span class="overdue-warning">ATRASADA!</span>' : ''}
                    </div>
                    <div class="task-actions">
                        <button class="edit-task-btn">Editar</button>
                        <button class="delete-task-btn">Excluir</button>
                    </div>
                `;
                
                item.querySelector('.focus-btn').addEventListener('click', () => toggleFocus(task.id));
                item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleTaskCompletion(task.id, e.target.checked));
                item.querySelector('.edit-task-btn').addEventListener('click', () => handleEdit(task));
                item.querySelector('.delete-task-btn').addEventListener('click', () => deleteTask(task.id));

                targetElement.appendChild(item);
            });
        }
        
        async function submitTaskForm(event) {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            const taskId = document.getElementById('task-id').value;

            const taskData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                dueDate: document.getElementById('delivery-date').value,
                priority: document.getElementById('priority').value,
                userId: parseInt(userId)
            };

            const url = taskId ? `${API_URL}/api/tasks/${taskId}` : `${API_URL}/api/tasks`;
            const method = taskId ? 'PUT' : 'POST';

            try {
                await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(taskData) });
                await loadTasks(userId);
                showSection(document.getElementById('my-tasks'));
            } catch (error) {
                alert('Não foi possível salvar a tarefa.');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Tem a certeza que deseja excluir esta tarefa?')) return;
            try {
                // CORREÇÃO: Verifica se a tarefa a ser excluída é o foco
                if (localStorage.getItem('focusTaskId') == taskId) {
                    localStorage.removeItem('focusTaskId');
                }
                await fetch(`${API_URL}/api/tasks/${taskId}`, { method: 'DELETE' });
                await loadTasks(localStorage.getItem('userId')); // Recarrega tudo para atualizar a UI
            } catch (error) {
                alert('Não foi possível excluir a tarefa.');
            }
        }
        
        function handleEdit(task) {
            showSection(document.getElementById('new-task-form-section'));
            document.getElementById('form-title').textContent = 'Editar Tarefa';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description;
            document.getElementById('delivery-date').value = task.dueDate;
            document.getElementById('priority').value = task.priority;
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
             try {
                await fetch(`${API_URL}/api/tasks/${taskId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ completed: isCompleted }) });
                await loadTasks(localStorage.getItem('userId'));
            } catch (error) {
                alert('Não foi possível atualizar o estado da tarefa.');
            }
        }

        function toggleFocus(taskId) {
            const currentFocus = localStorage.getItem('focusTaskId');
            if (currentFocus == taskId) {
                localStorage.removeItem('focusTaskId');
            } else {
                localStorage.setItem('focusTaskId', taskId);
            }
            renderUI();
        }

        function updateDashboard() {
            const total = allTasks.length;
            const completed = allTasks.filter(t => t.completed).length;
            const pending = total - completed;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-pending').textContent = pending;
            
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        function showMotivationalQuote() {
            const quotes = [
                "O segredo para progredir é começar.", "Acredite que você pode, assim você já está no meio do caminho.",
                "A persistência realiza o impossível.", "O sucesso é a soma de pequenos esforços repetidos dia após dia.",
                "Comece onde você está. Use o que você tem. Faça o que você pode."
            ];
            const randomIndex = Math.floor(Math.random() * quotes.length);
            document.getElementById('quote-container').textContent = `"${quotes[randomIndex]}"`;
        }
        
        // CORREÇÃO: Função para aplicar filtros
        function applyFilter(filter, tasks) {
            let filteredTasks = tasks;
            if (filter === 'pending') {
                filteredTasks = tasks.filter(task => !task.completed);
            } else if (filter === 'completed') {
                filteredTasks = tasks.filter(task => task.completed);
            }
            renderTaskList(filteredTasks, document.getElementById('task-list'));
        }

        // --- Lógica de Navegação e Conteúdo Dinâmico ---
        function showSection(sectionToShow) {
            [document.getElementById('my-tasks'), document.getElementById('about-taskflex'), 
             document.getElementById('new-task-form-section'), document.getElementById('dashboard-section'),
             document.getElementById('calendar-section') // Adicionado
            ].forEach(section => section.classList.add('hidden'));
            sectionToShow.classList.remove('hidden');
        }
        
        function loadDynamicContent() {
            document.getElementById('new-task-form-section').innerHTML = `
                <div class="container">
                    <h2 id="form-title">Nova Tarefa</h2>
                    <form id="task-form">
                        <input type="hidden" id="task-id">
                        <div class="form-group"><label for="task-title">Título:</label><input type="text" id="task-title" required></div>
                        <div class="form-group"><label for="task-description">Descrição:</label><textarea id="task-description" rows="4"></textarea></div>
                        <div class="form-group"><label for="delivery-date">Data de Entrega:</label><input type="date" id="delivery-date"></div>
                        <div class="form-group"><label for="priority">Prioridade:</label><select id="priority"><option value="high">Alta</option><option value="medium" selected>Média</option><option value="low">Baixa</option></select></div>
                        <div class="form-actions"><button type="submit" class="btn primary">Salvar</button><button type="button" class="btn secondary" id="btn-cancel-task">Cancelar</button></div>
                    </form>
                </div>`;
            
            document.getElementById('about-taskflex').innerHTML = `
                <div class="container">
                    <h2>Sobre o TaskFlex</h2>
                    <h3>Sua Solução Definitiva para Gerenciamento de Tarefas</h3>
                    <p>O TaskFlex é um site/aplicativo de gerenciamento de tarefas que permite ao usuário organizar atividades diárias, definir prazos e acompanhar o progresso de maneira visual e intuitiva.</p>
                    <h3>Problema que Resolvemos</h3>
                    <p>Muitas pessoas se perdem nas suas obrigações diárias por não terem uma forma simples e eficiente de organizar suas tarefas, o que gera estresse, baixa produtividade e esquecimento de compromissos importantes.</p>
                    <h3>Por que o TaskFlex é Bom e Necessário?</h3>
                    <ul>
                        <li><strong>Impacto Social:</strong> Aumenta a organização pessoal e o bem-estar dos usuários, reduzindo o estresse e promovendo uma rotina mais equilibrada.</li>
                        <li><strong>Impacto Econômico:</strong> Ajuda profissionais a ganharem produtividade, evitando retrabalho e otimizando o tempo, o que se traduz em maior eficiência e resultados.</li>
                        <li><strong>Impacto Ambiental:</strong> Reduz o uso de papel com anotações físicas, promovendo um planejamento digital e sustentável.</li>
                    </ul>
                </div>`;

            // Adiciona os event listeners aos elementos recém-criados e existentes
            document.getElementById('task-form').addEventListener('submit', submitTaskForm);
            document.getElementById('btn-cancel-task').addEventListener('click', () => showSection(document.getElementById('my-tasks')));
            document.getElementById('nav-my-tasks').addEventListener('click', (e) => { e.preventDefault(); showSection(document.getElementById('my-tasks')); });
            document.getElementById('nav-about').addEventListener('click', (e) => { e.preventDefault(); showSection(document.getElementById('about-taskflex')); });
            document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showSection(document.getElementById('dashboard-section')); });
            document.getElementById('btn-new-task').addEventListener('click', () => {
                document.getElementById('task-form').reset();
                document.getElementById('task-id').value = '';
                document.getElementById('form-title').textContent = 'Nova Tarefa';
                showSection(document.getElementById('new-task-form-section'));
            });

            // CORREÇÃO: Adiciona listeners para os botões de filtro
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const focusTask = localStorage.getItem('focusTaskId') ? allTasks.find(t => t.id == localStorage.getItem('focusTaskId')) : null;
                    const regularTasks = focusTask ? allTasks.filter(t => t.id != focusTask.id) : allTasks;
                    applyFilter(this.dataset.filter, regularTasks);
                });
            });

            // NOVO: Adiciona listeners para o calendário
            let currentDate = new Date();
            const currentMonthYearEl = document.getElementById('current-month-year');
            const calendarDaysEl = document.getElementById('calendar-days');

            function renderCalendar() {
                calendarDaysEl.innerHTML = '';
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                currentMonthYearEl.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

                const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const startDay = firstDayOfMonth.getDay();

                for (let i = 0; i < startDay; i++) { calendarDaysEl.innerHTML += `<div class="calendar-day empty"></div>`; }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('calendar-day');
                    dayDiv.textContent = day;
                    const today = new Date();
                    if (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth() && day === today.getDate()) {
                        dayDiv.classList.add('today');
                    }
                    calendarDaysEl.appendChild(dayDiv);
                }
            }
            document.getElementById('nav-calendar').addEventListener('click', (e) => { e.preventDefault(); showSection(document.getElementById('calendar-section')); renderCalendar(); });
            document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        }
    </script>
</body>
</html>
